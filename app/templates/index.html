{% extends "base.html" %}

{% block navbar %}
    {# Override blok navbar agar kosong, sehingga index.html tidak menampilkan navbar dari base.html #}
{% endblock navbar %}

{% block title %}Cek Kelayakan Masyarakat{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0"><i class="fas fa-search-dollar"></i> Cek Kelayakan Bantuan</h3>
                </div>
                <div class="card-body p-4">
                    

                    <form method="POST" action="" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="provinsi">Provinsi</label>
                                <select id="provinsi" name="provinsi" class="form-control custom-select">
                                    <option selected>-- Pilih Provinsi --</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="kabupaten">Kabupaten/Kota</label>
                                <select id="kabupaten" name="kabupaten" class="form-control custom-select" disabled>
                                    <option selected>-- Pilih Kabupaten/Kota --</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="kecamatan">Kecamatan</label>
                                <select id="kecamatan" name="kecamatan" class="form-control custom-select" disabled>
                                    <option selected>-- Pilih Kecamatan --</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="desa">Desa</label>
                                <select id="desa" name="desa" class="form-control custom-select" disabled>
                                    <option selected>-- Pilih Desa --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            {{ form.nama.label(class="form-control-label") }}
                            <div class="input-group">
                                {{ form.nama(class="form-control" + (" is-invalid" if form.nama.errors else ""), placeholder="Masukkan Nama Calon Penerima Manfaat") }}
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Cari Data</button>
                                </div>
                                {% if form.nama.errors %}
                                    <div class="invalid-feedback d-block">
                                        <span>{{ form.nama.errors[0] }}</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prediction Result Modal -->
<div class="modal fade" id="predictionModal" tabindex="-1" role="dialog" aria-labelledby="predictionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" id="predictionModalHeader">
                <h5 class="modal-title" id="predictionModalLabel"><i class="fas fa-poll"></i> Hasil Prediksi untuk: <strong id="predictionNama"></strong></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h5 class="mb-3"><i class="fas fa-map-marker-alt"></i> Informasi Alamat</h5>
                <ul class="list-group list-group-flush mb-4">
                    <li class="list-group-item d-flex justify-content-between align-items-center">Provinsi: <span class="font-weight-bold" id="predictionProvinsi"></span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Kabupaten/Kota: <span class="font-weight-bold" id="predictionKabupaten"></span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Kecamatan: <span class="font-weight-bold" id="predictionKecamatan"></span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Desa: <span class="font-weight-bold" id="predictionDesa"></span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Waktu Prediksi: <span class="font-weight-bold" id="predictionTimestamp"></span></li>
                </ul>
                <hr>
                <div class="text-center mb-4">
                    <h5 class="mb-3">Status Kelayakan (Metode KNN)</h5>
                    <span class="badge badge-pill p-3 w-50" id="predictionStatusBadge">
                        <h4 class="mb-0 text-white" id="predictionStatus"></h4>
                    </span>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-calculator"></i> Detail Skor (Metode SAW)</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">Skor Aktual: <span class="font-weight-bold" id="predictionSkorAktual"></span></li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">Skor Ternormalisasi: <span class="font-weight-bold" id="predictionSkorNormalisasi"></span></li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">Passing Grade: <span class="font-weight-bold text-primary" id="predictionPassingGrade"></span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> Ringkasan Faktor Penentu</h6>
                        <p id="predictionSummary" class="text-muted"></p>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">Terdaftar di DTKS: <span class="font-weight-bold" id="predictionDTKS"></span></li>
                            <li class="list-group-item" id="predictionFaktorPenambahContainer">Penambah Skor: <span class="font-weight-bold" id="predictionFaktorPenambah"></span></li>
                            <li class="list-group-item" id="predictionFaktorPengurangContainer">Pengurang Skor: <span class="font-weight-bold" id="predictionFaktorPengurang"></span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const provinsiSelect = document.getElementById('provinsi');
    const kabupatenSelect = document.getElementById('kabupaten');
    const kecamatanSelect = document.getElementById('kecamatan');
    const desaSelect = document.getElementById('desa');
    const selects = [kabupatenSelect, kecamatanSelect, desaSelect];

    const apiBaseUrl = 'https://www.emsifa.com/api-wilayah-indonesia/api/';

    function resetSelect(select, defaultText) {
        select.innerHTML = `<option selected>-- ${defaultText} --</option>`;
        select.disabled = true;
    }

    // Fetch and populate provinsi
    fetch(apiBaseUrl + 'provinces.json')
        .then(response => response.json())
        .then(provinces => {
            provinces.forEach(provinsi => {
                const option = document.createElement('option');
                option.value = provinsi.id;
                option.textContent = provinsi.name;
                provinsiSelect.appendChild(option);
            });
        });

    provinsiSelect.addEventListener('change', function () {
        const provinsiId = this.value;
        resetSelect(kabupatenSelect, 'Pilih Kabupaten/Kota');
        resetSelect(kecamatanSelect, 'Pilih Kecamatan');
        resetSelect(desaSelect, 'Pilih Desa');

        if (provinsiId) {
            kabupatenSelect.disabled = false;
            fetch(apiBaseUrl + `regencies/${provinsiId}.json`)
                .then(response => response.json())
                .then(regencies => {
                    regencies.forEach(kabupaten => {
                        const option = document.createElement('option');
                        option.value = kabupaten.id;
                        option.textContent = kabupaten.name;
                        kabupatenSelect.appendChild(option);
                    });
                });
        }
    });

    kabupatenSelect.addEventListener('change', function () {
        const kabupatenId = this.value;
        resetSelect(kecamatanSelect, 'Pilih Kecamatan');
        resetSelect(desaSelect, 'Pilih Desa');

        if (kabupatenId) {
            kecamatanSelect.disabled = false;
            fetch(apiBaseUrl + `districts/${kabupatenId}.json`)
                .then(response => response.json())
                .then(districts => {
                    districts.forEach(kecamatan => {
                        const option = document.createElement('option');
                        option.value = kecamatan.id;
                        option.textContent = kecamatan.name;
                        kecamatanSelect.appendChild(option);
                    });
                });
        }
    });

    kecamatanSelect.addEventListener('change', function () {
        const kecamatanId = this.value;
        resetSelect(desaSelect, 'Pilih Desa');

        if (kecamatanId) {
            desaSelect.disabled = false;
            fetch(apiBaseUrl + `villages/${kecamatanId}.json`)
                .then(response => response.json())
                .then(villages => {
                    villages.forEach(desa => {
                        const option = document.createElement('option');
                        option.value = desa.id;
                        option.textContent = desa.name;
                        desaSelect.appendChild(option);
                    });
                });
        }
    });

    // Handle prediction result display in modal
    const predictionData = JSON.parse('{{ prediction | tojson | safe if prediction else "null" }}');

    if (predictionData) {
        const predictionModal = document.getElementById('predictionModal');
        const predictionModalHeader = document.getElementById('predictionModalHeader');

        // Set modal header background based on prediction status
        predictionModalHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white', 'text-dark');
        if (predictionData.status_kelayakan_knn === 'Layak') {
            predictionModalHeader.classList.add('bg-success', 'text-white');
        } else if (predictionData.status_kelayakan_knn === 'Tidak Layak') {
            predictionModalHeader.classList.add('bg-danger', 'text-white');
        } else {
            predictionModalHeader.classList.add('bg-warning', 'text-dark');
        }

        document.getElementById('predictionNama').textContent = predictionData.nama;
        document.getElementById('predictionProvinsi').textContent = predictionData.provinsi;
        document.getElementById('predictionKabupaten').textContent = predictionData.kabupaten;
        document.getElementById('predictionKecamatan').textContent = predictionData.kecamatan;
        document.getElementById('predictionDesa').textContent = predictionData.desa;

        const statusBadge = document.getElementById('predictionStatusBadge');
        const statusText = document.getElementById('predictionStatus');
        statusText.textContent = predictionData.status_kelayakan_knn;

        // Remove existing classes and add new one based on status
        statusBadge.classList.remove('badge-success', 'badge-danger', 'badge-warning');
        if (predictionData.status_kelayakan_knn === 'Layak') {
            statusBadge.classList.add('badge-success');
        } else if (predictionData.status_kelayakan_knn === 'Tidak Layak') {
            statusBadge.classList.add('badge-danger');
        } else {
            statusBadge.classList.add('badge-warning');
        }

        document.getElementById('predictionSkorAktual').textContent = predictionData.skor_total_saw_aktual.toFixed(3);
        document.getElementById('predictionSkorNormalisasi').textContent = predictionData.skor_saw_ternormalisasi.toFixed(3);
        document.getElementById('predictionPassingGrade').textContent = predictionData.passing_grade_digunakan_saw;
        document.getElementById('predictionTimestamp').textContent = predictionData.timestamp;

        document.getElementById('predictionDTKS').textContent = predictionData.alasan.DTKS ? 'Ya' : 'Tidak';

        const faktorPenambahContainer = document.getElementById('predictionFaktorPenambahContainer');
        const faktorPenambah = document.getElementById('predictionFaktorPenambah');
        const faktorPengurangContainer = document.getElementById('predictionFaktorPengurangContainer');
        const faktorPengurang = document.getElementById('predictionFaktorPengurang');
        const predictionSummary = document.getElementById('predictionSummary');

        let summaryText = '';
        if (predictionData.status_kelayakan_knn === 'Layak') {
            if (predictionData.alasan['Faktor Penambah Skor'] && predictionData.alasan['Faktor Penambah Skor'].length > 0) {
                summaryText = 'Layak karena: ' + predictionData.alasan['Faktor Penambah Skor'].join(', ') + '.';
            } else {
                summaryText = 'Layak berdasarkan skor dan kriteria umum.';
            }
        } else if (predictionData.status_kelayakan_knn === 'Tidak Layak') {
            if (predictionData.alasan['Faktor Pengurang Skor'] && predictionData.alasan['Faktor Pengurang Skor'].length > 0) {
                summaryText = 'Tidak Layak karena: ' + predictionData.alasan['Faktor Pengurang Skor'].join(', ') + '.';
            } else {
                summaryText = 'Tidak Layak berdasarkan skor dan kriteria umum.';
            }
        }
        predictionSummary.textContent = summaryText;

        if (predictionData.alasan['Faktor Penambah Skor'] && predictionData.alasan['Faktor Penambah Skor'].length > 0) {
            faktorPenambah.textContent = predictionData.alasan['Faktor Penambah Skor'].join(', ');
            faktorPenambahContainer.style.display = '';
        } else {
            faktorPenambahContainer.style.display = 'none';
        }

        if (predictionData.alasan['Faktor Pengurang Skor'] && predictionData.alasan['Faktor Pengurang Skor'].length > 0) {
            faktorPengurang.textContent = predictionData.alasan['Faktor Pengurang Skor'].join(', ');
            faktorPengurangContainer.style.display = '';
        } else {
            faktorPengurangContainer.style.display = 'none';
        }

        // Show the modal
        $(predictionModal).modal('show');
    }
});
</script>
{% endblock scripts %}