{% extends "base.html" %}

{% block navbar %}
    {# Override blok navbar agar kosong, sehingga index.html tidak menampilkan navbar dari base.html #}
{% endblock navbar %}

{% block title %}Cek Kelayakan Masyarakat{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0"><i class="fas fa-search-dollar"></i> Cek Kelayakan Bantuan</h3>
                </div>
                <div class="card-body p-4">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="provinsi">Provinsi</label>
                                <select id="provinsi" name="provinsi" class="form-control custom-select">
                                    <option selected>-- Pilih Provinsi --</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="kabupaten">Kabupaten/Kota</label>
                                <select id="kabupaten" name="kabupaten" class="form-control custom-select" disabled>
                                    <option selected>-- Pilih Kabupaten/Kota --</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="kecamatan">Kecamatan</label>
                                <select id="kecamatan" name="kecamatan" class="form-control custom-select" disabled>
                                    <option selected>-- Pilih Kecamatan --</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="desa">Desa</label>
                                <select id="desa" name="desa" class="form-control custom-select" disabled>
                                    <option selected>-- Pilih Desa --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            {{ form.nama.label(class="form-control-label") }}
                            <div class="input-group">
                                {{ form.nama(class="form-control" + (" is-invalid" if form.nama.errors else ""), placeholder="Masukkan Nama Calon Penerima Manfaat") }}
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Cari Data</button>
                                </div>
                                {% if form.nama.errors %}
                                    <div class="invalid-feedback d-block">
                                        <span>{{ form.nama.errors[0] }}</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            {% if prediction %}
            <div class="card shadow-lg border-0">
                <div class="card-header {% if prediction.status_kelayakan_knn == 'Layak' %}bg-success text-white{% elif prediction.status_kelayakan_knn == 'Tidak Layak' %}bg-danger text-white{% else %}bg-warning text-dark{% endif %}">
                    <h4 class="mb-0 text-center"><i class="fas fa-poll"></i> Hasil Prediksi untuk: <strong>{{ prediction.nama }}</strong></h4>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h5 class="mb-3">Status Kelayakan (Metode KNN)</h5>
                        <span class="badge badge-pill p-3 w-50 {% if prediction.status_kelayakan_knn == 'Layak' %}badge-success{% elif prediction.status_kelayakan_knn == 'Tidak Layak' %}badge-danger{% else %}badge-warning{% endif %}">
                            <h4 class="mb-0 text-white">{{ prediction.status_kelayakan_knn }}</h4>
                        </span>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-calculator"></i> Detail Skor (Metode SAW)</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">Skor Aktual: <span class="font-weight-bold">{{ prediction.skor_total_saw_aktual | round(3) }}</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Skor Ternormalisasi: <span class="font-weight-bold">{{ prediction.skor_saw_ternormalisasi | round(3) }}</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Passing Grade: <span class="font-weight-bold">{{ prediction.passing_grade_digunakan_saw }}</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle"></i> Faktor Penentu</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">Terdaftar di DTKS: <span class="font-weight-bold">{{ 'Ya' if prediction.alasan.DTKS else 'Tidak' }}</span></li>
                                {% if prediction.alasan['Faktor Penambah Skor'] %}<li class="list-group-item">Penambah Skor: <span class="font-weight-bold">{{ prediction.alasan['Faktor Penambah Skor'] | join(', ') }}</span></li>{% endif %}
                                {% if prediction.alasan['Faktor Pengurang Skor'] %}<li class="list-group-item">Pengurang Skor: <span class="font-weight-bold">{{ prediction.alasan['Faktor Pengurang Skor'] | join(', ') }}</span></li>{% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const provinsiSelect = document.getElementById('provinsi');
    const kabupatenSelect = document.getElementById('kabupaten');
    const kecamatanSelect = document.getElementById('kecamatan');
    const desaSelect = document.getElementById('desa');
    const selects = [kabupatenSelect, kecamatanSelect, desaSelect];

    const apiBaseUrl = 'https://www.emsifa.com/api-wilayah-indonesia/api/';

    function resetSelect(select, defaultText) {
        select.innerHTML = `<option selected>-- ${defaultText} --</option>`;
        select.disabled = true;
    }

    // Fetch and populate provinsi
    fetch(apiBaseUrl + 'provinces.json')
        .then(response => response.json())
        .then(provinces => {
            provinces.forEach(provinsi => {
                const option = document.createElement('option');
                option.value = provinsi.id;
                option.textContent = provinsi.name;
                provinsiSelect.appendChild(option);
            });
        });

    provinsiSelect.addEventListener('change', function () {
        const provinsiId = this.value;
        resetSelect(kabupatenSelect, 'Pilih Kabupaten/Kota');
        resetSelect(kecamatanSelect, 'Pilih Kecamatan');
        resetSelect(desaSelect, 'Pilih Desa');

        if (provinsiId) {
            kabupatenSelect.disabled = false;
            fetch(apiBaseUrl + `regencies/${provinsiId}.json`)
                .then(response => response.json())
                .then(regencies => {
                    regencies.forEach(kabupaten => {
                        const option = document.createElement('option');
                        option.value = kabupaten.id;
                        option.textContent = kabupaten.name;
                        kabupatenSelect.appendChild(option);
                    });
                });
        }
    });

    kabupatenSelect.addEventListener('change', function () {
        const kabupatenId = this.value;
        resetSelect(kecamatanSelect, 'Pilih Kecamatan');
        resetSelect(desaSelect, 'Pilih Desa');

        if (kabupatenId) {
            kecamatanSelect.disabled = false;
            fetch(apiBaseUrl + `districts/${kabupatenId}.json`)
                .then(response => response.json())
                .then(districts => {
                    districts.forEach(kecamatan => {
                        const option = document.createElement('option');
                        option.value = kecamatan.id;
                        option.textContent = kecamatan.name;
                        kecamatanSelect.appendChild(option);
                    });
                });
        }
    });

    kecamatanSelect.addEventListener('change', function () {
        const kecamatanId = this.value;
        resetSelect(desaSelect, 'Pilih Desa');

        if (kecamatanId) {
            desaSelect.disabled = false;
            fetch(apiBaseUrl + `villages/${kecamatanId}.json`)
                .then(response => response.json())
                .then(villages => {
                    villages.forEach(desa => {
                        const option = document.createElement('option');
                        option.value = desa.id;
                        option.textContent = desa.name;
                        desaSelect.appendChild(option);
                    });
                });
        }
    });
});
</script>
{% endblock %}

